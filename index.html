<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>


<script
	src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.9.2/dropbox.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

<script src="lib/jquery.jstree.js"></script>
<!-- 
TODO: Create this file with your own encoded key.  The format should be:
	var encodedKey = "#######";
 -->
<script src="lib/config.js"></script>
<script src="lib/ajax_load.js"></script>

<script>
	client = null;

	function getEachInFolder(client, path, callback) {
		client.readdir(path, function(error, entries, folderStat, childrenStat) {
			if (error) {
				return callback(error); // Something went wrong.
			}
			console.log(entries)
			console.log(folderStat);
			console.log(childrenStat);
			for ( var j in childrenStat) {
				console.log(childrenStat[j])
				var name = childrenStat[j].name;
				var type = "folder";
				if (childrenStat[j].isFile) {
					type = "file";
				}

				callback(null, name, type, childrenStat[j])
			}
		});
	}

	function getTree(c) {
		var client = c;
		return function(node, callback) {

			console.log("the context node");
			console.log(node);
			var data = [];
			client.readdir("/", function(error, entries, folderStat, childrenStat) {
				if (error) {
					return callback(error); // Something went wrong.
				}
				for ( var j in childrenStat) {
					var dd = {
						data : childrenStat[j].name
					};
					if (childrenStat[j].isFolder) {
						dd["state"] = "closed";
					}

					data.push(dd);
				}
				callback(data);
			});
		}
	}

	function doSomethingCool() {

		$("#signed-in").html("signed in");
		$("#sign_out").show();
		$("#sign_in").hide();

		client.getUserInfo(function(error, accountInfo) {
			if (error) {
				return showError(error); // Something went wrong.
			}
			console.log(accountInfo);
		});

		$("#demo1").jstree({
			"ajax_data" : {
				"data" : getTree(client),
				"progressive_render" : true,
				"progressive_unload" : true
			},
			"plugins" : [ "themes", "ajax_data", "ui", "crrm" ]
		}).bind("select_node.jstree", function(e, data) {
			console.log(data.rslt.obj);
		}).bind("load_node", function(node, success, error) {
			console.log("here");
		});

	}

	$(function() {

		var options = {
			key : "7gEUKqBKKFA=|PXzIjIAUQejJd0o2o69gZppgVx0mXhyeDBagtxNU+A==",
			sandbox : true
		};

		client = new Dropbox.Client(options);

		client.authDriver(new Dropbox.Drivers.Redirect({
			useQuery : true,
			rememberUser : true
		}));

		$("#sign_out").hide();
		$("#sign_in").hide();

		client.authenticate({
			interactive : false
		}, function(error, c) {
			client = c;
			if (error) {
				return handleError(error);
			}

			if (client.isAuthenticated()) {
				// Cached credentials are available, make Dropbox API calls.
				doSomethingCool();
			} else {
				// show and set up the "Sign into Dropbox" button
				$("#sign_out").hide();
				$("#sign_in").show();
			}
		});

		$("#sign_in").click(function() {
			// The user will have to click an 'Authorize' button.
			client.authenticate(function(error, client) {
				if (error) {
					return handleError(error);
				}
				doSomethingCool();
			});
		});

		$("#sign_out").click(function() {
			client.signOut(function(error) {
				if (!error) {
					console.log("signed out");

					client = new Dropbox.Client(options);

					client.authDriver(new Dropbox.Drivers.Redirect({
						useQuery : true,
						rememberUser : true
					}));

					$("#sign_out").hide();
					$("#signed-in").html("not signed in");
					$("#sign_in").show();
				} else {
					console.dir(error);
				}
			});
		});
	});
</script>

<style>
#demo1 {
	border: 2px solid;
	position: absolute;
	top: 120px;
	bottom: 20px;
	width: 300px;
	overflow: scroll;
}
</style>

</head>
<body>
	<h1>Dropbox Test Page</h1>
	<input type="button" id="sign_in" value="sign in">
	<input type="button" id="sign_out" value="sign out">
	<div id="signed-in"></div>
	<div id="demo1"></div>
</body>
</html>