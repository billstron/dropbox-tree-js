<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Insert title here</title>


<script
	src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.9.2/dropbox.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

<script src="lib/jquery.jstree.js"></script>
<!-- 
TODO: Create this file with your own encoded key.  The format should be:
	var encodedKey = "#######";
 -->
<script src="lib/config.js"></script>
<script src="lib/ajax_load.js"></script>

<script>
	client = null;

	function getJson(name, path, type) {
		var childPath = path + "/" + name;
		var dd = {
			data : {
				title : name,
				icon : type
			},
			attr : {
				id : "node_" + childPath
			},
			metadata : {
				type : type,
				path : childPath
			}

		};
		if (type == "folder") {
			dd["state"] = "closed";
		}

		return dd;
	}

	function getTree(c) {
		var client = c;
		return function(node, callback) {

			var path = "";
			if ($(node).data("path")) {
				path = $(node).data("path");
			}

			console.log("load path:", path);

			var data = [];
			client.readdir(path, function(error, entries, folderStat, childrenStat) {
				if (error) {
					return callback(error); // Something went wrong.
				}
				for ( var j in childrenStat) {
					var type = (childrenStat[j].isFolder) ? "folder" : "file";
					var dd = getJson(childrenStat[j].name, path, type)
					data.push(dd);
				}
				callback(data);
			});
		}
	}

	function doubleClick(timeout, callback) {
		var self = this;
		this.tLast = (new Date()).getTime();
		this.timeout = timeout;
		this.callback = callback;
		this.nodeLast = null;

		this.clicked = function clicked(e, data) {
			var tNew = (new Date()).getTime();
			var node = $(data.rslt.obj).attr("id");
			var dt = tNew - self.tLast;
			if (dt < self.timeout && node == self.nodeLast) {
				this.callback(data);
			}
			self.tLast = tNew;
			self.nodeLast = node;
		}
	}

	var dClick = new doubleClick(300, function(data) {
		console.log("double clicked");
		open(data.rslt.obj);
	});

	function open(node) {
		var path = $(node).data("path");
		switch ($(node).data("type")) {
		case "folder":
			$("#tree-window").jstree("open_node", node, function() {
				console.log("opended node");
			});
			break;
		default:
		case "file":
			client.readFile(path, function(error, data) {
				if (error) {
					return console.log("error:", error);
				}
				$("#editor-window").html(data);
			});
			break
		}
	}

	function onCreate(name, node, data) {
		var path = $(node).data("path");
		var id = node.attr("id");
		var type = $(node).data("type");
		//var name = node.name;
		path += "/" + name;
		$(node).data("path", path);
		node.attr("id")
		switch (type) {
		case "folder":
			client.mkdir(path, function(err) {
				if (err) {
					writeMessage("Dropbox could not create folder.")
					return $.jstree.rollback(data.rlbk);
				}
				node.attr("id", node.attr("id") + node.name);
				console.log("directory just created");
			})
			break;
		default:
		case "file":
			client.writeFile(path, "", function(err) {
				if (err) {
					writeMessage("Dropbox could not create file.")
					return $.jstree.rollback(data.rlbk);
				}
				node.attr("id", node.attr("id") + node.name);
				console.log("file just created");
			});
			break
		}
	}

	function newGeneric(type) {
		var parent = $("#tree-window").jstree("get_selected");

		var path = "/";
		var position = "inside";
		if (parent && $(parent).data("path")) {
			path = $(parent).data("path");
		}

		if ($(parent).data("type") && $(parent).data("type") == "file") {
			position = "after";
			var pathToks = path.split("/");
			path = "";
			for ( var i = 0; i < pathToks.length - 1; i++) {
				if (pathToks[i] != "") {
					path += ("/" + pathToks[i]);
				}
			}
		}

		var data = {
			attr : {
				id : id
			},
			metadata : {
				path : path,
				type : type
			}
		};
		if(type == "folder"){
			data.state = "closed";
		}

		var id = "node_" + path + "/";
		$("#tree-window").jstree("create", parent, position, data);
	}

	function remove(name, node, data) {
		var path = node.data("path");
		console.log("trying to delete file: ", path);
		client.remove(path, function(err) {
			if (err) {
				writeMessage("Dropbox could not remove.")
				return $.jstree.rollback(data.rlbk);
			}
			console.log("file just removed");
		})
	}

	function copy(name, node, data) {
		var path = $("#tree-window").jstree("get_selected").data("path");
		var pathToks = path.split("/");
		var name = pathToks[pathToks.length - 1];
		/* var path = node.data("path"); */
		var newName = name + " copy";
		$("#tree-window").jstree("rename_node", node, newName);

		var newPath = "/";
		for ( var i = 0; i < pathToks.length - 2; i++) {
			newPath += (pathToks[i] + "/");
		}
		newPath += newName;

		$(node).attr("id", "node_" + newPath);
		$(node).data("path", newPath);
		console.log("trying to delete file: ", path);
		client.copy(path, newPath, function(err) {
			if (err) {
				writeMessage("Dropbox could not copy.")
				return $.jstree.rollback(data.rlbk);
			}
			console.log("copy successful");
		})
	}

	var msgTout = null;
	function writeMessage(txt) {
		clearTimeout(msgTout);
		$("#message-window span").html(txt);
		msgTout = setTimeout(function() {
			$("#message-window span").html("");
		}, 5000);
	}

	function doSomethingCool() {

		$("#signed-in").html("signed in");
		$("#sign_out").show();
		$("#sign_in").hide();

		client.getUserInfo(function(error, accountInfo) {
			if (error) {
				return showError(error); // Something went wrong.
			}
			console.log(accountInfo);
		});

		$("#tree-window").jstree({
			"ajax_data" : {
				"data" : getTree(client),
				"progressive_render" : true,
				"progressive_unload" : true
			},
			"plugins" : [ "themes", "ajax_data", "ui", "crrm" ]
		}).bind("select_node.jstree", function(e, data) {
			dClick.clicked(e, data);
			console.log("node selected:", $(data.rslt.obj).data("path"));
		}).bind("load_node", function(node, success, error) {
			console.log("here");
		}).bind("create.jstree", function(e, data) {
			onCreate(data.rslt.name, data.rslt.obj, data);
		}).bind("remove.jstree", function(e, data) {
			remove(data.rslt.name, data.rslt.obj, data);
		}).bind("loaded.jstree", function() {
			writeMessage("Tree loaded");
		}).bind("move_node.jstree", function(e, data) {
			copy(data.rslt.name, data.rslt.oc, data);
		});
	}

	$(function() {

		writeMessage("loading");

		var options = {
			key : "7gEUKqBKKFA=|PXzIjIAUQejJd0o2o69gZppgVx0mXhyeDBagtxNU+A==",
			sandbox : true
		};

		client = new Dropbox.Client(options);

		client.authDriver(new Dropbox.Drivers.Redirect({
			useQuery : true,
			rememberUser : true
		}));

		$("#sign_out").hide();
		$("#sign_in").hide();

		client.authenticate({
			interactive : false
		}, function(error, c) {
			client = c;
			if (error) {
				return handleError(error);
			}

			if (client.isAuthenticated()) {
				// Cached credentials are available, make Dropbox API calls.
				doSomethingCool();
			} else {
				// show and set up the "Sign into Dropbox" button
				$("#sign_out").hide();
				$("#sign_in").show();
			}
		});

		$("#sign_in").click(function() {
			// The user will have to click an 'Authorize' button.
			client.authenticate(function(error, client) {
				if (error) {
					return handleError(error);
				}
				doSomethingCool();
			});
		});

		$("#sign_out").click(function() {
			client.signOut(function(error) {
				if (!error) {
					console.log("signed out");

					client = new Dropbox.Client(options);

					client.authDriver(new Dropbox.Drivers.Redirect({
						useQuery : true,
						rememberUser : true
					}));

					$("#sign_out").hide();
					$("#signed-in").html("not signed in");
					$("#sign_in").show();
				} else {
					console.dir(error);
				}
			});
		});

		$("#file-open").click(function() {
			open($("#tree-window").jstree("get_selected"));
		});

		$("#file-new-file").click(function() {
			newGeneric("file");
		});

		$("#file-new-folder").click(function() {
			newGeneric("folder");
		});

		$("#file-delete").click(function() {
			var node = $("#tree-window").jstree("get_selected");
			$("#tree-window").jstree("remove", node);
		});

		$("#file-copy").click(function() {
			console.log("copying node");
			var node = $("#tree-window").jstree("get_selected");
			$("#tree-window").jstree("move_node", node, null, "after", true, false, true);
		});
	});
</script>

<style>
.container {
	position: absolute;
	left: 0px;
	top: 120px;
	bottom: 20px;
	width: 905px;
}

#tree-window {
	border: 2px solid;
	position: absolute;
	left: 0px;
	top: 30px;
	bottom: 0px;
	width: 300px;;
	overflow: scroll;
}

#editor-window {
	float: left;
	border: 2px solid;
	position: absolute;
	right: 0px;
	top: 30px;
	bottom: 0px;
	width: 600px;
	overflow: scroll;
}

#message-window {
	position: absolute;
	left: 0px;
	bottom: 0px;
}
</style>

</head>
<body>
	<h1>Dropbox Test Page</h1>
	<input type="button" id="sign_in" value="sign in">
	<input type="button" id="sign_out" value="sign out">
	<div id="signed-in"></div>

	<div class="container">
		<input type="button" id="file-open" value="Open"> <input
			type="button" id="file-new-file" value="New File"> <input
			type="button" id="file-new-folder" value="New Folder"> <input
			type="button" id="file-copy" value="Copy"> <input
			type="button" id="file-delete" value="Delete">

		<div id="tree-window"></div>
		<div id="message-window">
			<span></span>
		</div>

		<div id="editor-window"></div>
	</div>
</body>
</html>